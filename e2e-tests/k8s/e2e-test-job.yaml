apiVersion: batch/v1
kind: Job
metadata:
  name: e2e-test-runner
  namespace: ecommerce
spec:
  backoffLimit: 2
  ttlSecondsAfterFinished: 3600  # Cleanup after 1 hour
  template:
    metadata:
      labels:
        app: e2e-test-runner
    spec:
      restartPolicy: Never
      containers:
      - name: maven-test-runner
        image: maven:3.8-openjdk-11
        command:
        - /bin/sh
        - -c
        - |
          set -e
          echo "üß™ Preparando entorno de pruebas E2E..."
          
          # Instalar dependencias necesarias
          apt-get update && apt-get install -y curl kubectl || true
          
          # Esperar a que los servicios est√©n listos
          echo "‚è≥ Esperando que los servicios est√©n listos..."
          timeout 300 bash -c 'until kubectl get deployment -n ecommerce user-service -o jsonpath="{.status.readyReplicas}" | grep -q "1"; do sleep 5; done' || true
          timeout 300 bash -c 'until kubectl get deployment -n ecommerce product-service -o jsonpath="{.status.readyReplicas}" | grep -q "1"; do sleep 5; done' || true
          timeout 300 bash -c 'until kubectl get deployment -n ecommerce order-service -o jsonpath="{.status.readyReplicas}" | grep -q "1"; do sleep 5; done' || true
          
          echo "‚úÖ Servicios listos"
          
          # Verificar conectividad a servicios usando DNS interno del cluster
          echo "üîç Verificando conectividad..."
          SERVICES=(
            "user-service.ecommerce.svc.cluster.local:8085"
            "product-service.ecommerce.svc.cluster.local:8083"
            "order-service.ecommerce.svc.cluster.local:8081"
            "payment-service.ecommerce.svc.cluster.local:8082"
            "shipping-service.ecommerce.svc.cluster.local:8084"
            "favourite-service.ecommerce.svc.cluster.local:8086"
          )
          
          for service in "${SERVICES[@]}"; do
            if curl -sf "http://${service}/$(echo ${service} | cut -d. -f1 | sed 's/-service//')-service/actuator/health" > /dev/null; then
              echo "‚úÖ ${service} accesible"
            else
              echo "‚ö†Ô∏è  ${service} no responde"
            fi
          done
          
          echo ""
          echo "üß™ Ejecutando pruebas E2E..."
          
          # Nota: El c√≥digo fuente debe estar disponible en el pod
          # Opciones:
          # 1. Montar un volumen con el c√≥digo
          # 2. Clonar desde un repositorio
          # 3. Usar una imagen Docker personalizada con el c√≥digo
          
          echo "‚ö†Ô∏è  Este Job requiere que el c√≥digo fuente est√© disponible"
          echo "üí° Considera:"
          echo "   - Montar un volumen con el c√≥digo"
          echo "   - Clonar desde Git"
          echo "   - Usar una imagen Docker con el c√≥digo pre-compilado"
          
          # Ejemplo: Si el c√≥digo est√° montado en /workspace
          if [ -d "/workspace/e2e-tests" ]; then
            cd /workspace/e2e-tests
            
            # Configurar URLs de servicios usando DNS interno
            export CLUSTER_BASE_URL=""
            export USER_SERVICE_URL="http://user-service.ecommerce.svc.cluster.local:8085"
            export USER_SERVICE_CONTEXT="/user-service"
            export PRODUCT_SERVICE_URL="http://product-service.ecommerce.svc.cluster.local:8083"
            export PRODUCT_SERVICE_CONTEXT="/product-service"
            export ORDER_SERVICE_URL="http://order-service.ecommerce.svc.cluster.local:8081"
            export ORDER_SERVICE_CONTEXT="/order-service"
            export PAYMENT_SERVICE_URL="http://payment-service.ecommerce.svc.cluster.local:8082"
            export PAYMENT_SERVICE_CONTEXT="/payment-service"
            export SHIPPING_SERVICE_URL="http://shipping-service.ecommerce.svc.cluster.local:8084"
            export SHIPPING_SERVICE_CONTEXT="/shipping-service"
            export FAVOURITE_SERVICE_URL="http://favourite-service.ecommerce.svc.cluster.local:8086"
            export FAVOURITE_SERVICE_CONTEXT="/favourite-service"
            
            ./mvnw clean test -Dspring.profiles.active=test,cluster -Dtest=*E2E*Test
          else
            echo "‚ùå C√≥digo fuente no encontrado en /workspace/e2e-tests"
            echo "üí° Monta el c√≥digo o clona el repositorio"
            exit 1
          fi
        env:
        - name: KUBERNETES_NAMESPACE
          value: "ecommerce"
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "1000m"
        volumeMounts:
        - name: workspace
          mountPath: /workspace
          readOnly: false
      volumes:
      - name: workspace
        # Opci√≥n 1: Montar un volumen persistente con el c√≥digo
        # persistentVolumeClaim:
        #   claimName: e2e-tests-pvc
        # Opci√≥n 2: Montar desde un hostPath (solo para desarrollo local)
        hostPath:
          path: /tmp/e2e-tests
          type: DirectoryOrCreate
      serviceAccountName: default

